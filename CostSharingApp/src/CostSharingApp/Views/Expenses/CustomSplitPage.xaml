<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CostSharingApp.ViewModels.Expenses"
             x:Class="CostSharingApp.Views.Expenses.CustomSplitPage"
             x:DataType="vm:CustomSplitViewModel"
             Title="Custom Split">
    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">
            <!-- Instructions -->
            <Frame BackgroundColor="{StaticResource Secondary}" Padding="12" CornerRadius="8">
                <StackLayout Spacing="4">
                    <Label Text="ðŸ’¡ Custom Split"
                           FontSize="16"
                           FontAttributes="Bold" />
                    <Label Text="Assign custom percentages to each member. Total must equal 100%."
                           FontSize="12"
                           TextColor="{StaticResource Gray600}" />
                </StackLayout>
            </Frame>

            <!-- Expense Info -->
            <Frame Padding="12" CornerRadius="8">
                <Grid ColumnDefinitions="*,Auto">
                    <StackLayout Grid.Column="0">
                        <Label Text="Total Amount"
                               FontSize="12"
                               TextColor="{StaticResource Gray500}" />
                        <Label Text="{Binding TotalAmount, StringFormat='${0:F2}'}"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Primary}" />
                    </StackLayout>
                    <StackLayout Grid.Column="1" HorizontalOptions="End">
                        <Label Text="Percentage Sum"
                               FontSize="12"
                               TextColor="{StaticResource Gray500}"
                               HorizontalTextAlignment="End" />
                        <Label Text="{Binding TotalPercentage, StringFormat='{0:F1}%'}"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalTextAlignment="End">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label"
                                           Binding="{Binding IsValid}"
                                           Value="True">
                                    <Setter Property="TextColor" Value="Green" />
                                </DataTrigger>
                                <DataTrigger TargetType="Label"
                                           Binding="{Binding IsValid}"
                                           Value="False">
                                    <Setter Property="TextColor" Value="{StaticResource Danger}" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </StackLayout>
                </Grid>
            </Frame>

            <!-- Member Percentages -->
            <Label Text="Assign Percentages" FontSize="18" FontAttributes="Bold" />

            <CollectionView ItemsSource="{Binding MemberSplits}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="12" Margin="0,0,0,8" CornerRadius="8">
                            <Grid ColumnDefinitions="*,120,80" ColumnSpacing="12">
                                <!-- Member Name -->
                                <StackLayout Grid.Column="0" VerticalOptions="Center">
                                    <Label Text="{Binding UserId, StringFormat='User: {0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold" />
                                    <Label Text="{Binding CalculatedAmount, StringFormat='= ${0:F2}'}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}" />
                                </StackLayout>

                                <!-- Percentage Input -->
                                <Entry Grid.Column="1"
                                       Text="{Binding Percentage, Mode=TwoWay}"
                                       Placeholder="0.0"
                                       Keyboard="Numeric"
                                       HorizontalTextAlignment="End"
                                       VerticalOptions="Center" />

                                <Label Grid.Column="2"
                                       Text="%"
                                       FontSize="16"
                                       VerticalOptions="Center"
                                       Margin="8,0,0,0" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Quick Actions -->
            <HorizontalStackLayout Spacing="8">
                <Button Text="Equal Split"
                        Command="{Binding EqualSplitCommand}"
                        FontSize="12"
                        Padding="12,6"
                        HorizontalOptions="Start" />
                <Button Text="Reset"
                        Command="{Binding ResetCommand}"
                        FontSize="12"
                        Padding="12,6"
                        BackgroundColor="{StaticResource Gray300}"
                        TextColor="{StaticResource Gray900}"
                        HorizontalOptions="Start" />
            </HorizontalStackLayout>

            <!-- Error Message -->
            <Label Text="{Binding ErrorMessage}"
                   TextColor="{StaticResource Danger}"
                   IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                   Margin="0,8,0,0" />

            <!-- Action Buttons -->
            <HorizontalStackLayout Spacing="12" Margin="0,16,0,0">
                <Button Text="Cancel"
                        Command="{Binding CancelCommand}"
                        BackgroundColor="{StaticResource Gray300}"
                        TextColor="{StaticResource Gray900}"
                        HorizontalOptions="FillAndExpand" />
                <Button Text="Apply Split"
                        Command="{Binding ApplySplitCommand}"
                        HorizontalOptions="FillAndExpand"
                        IsEnabled="{Binding IsValid}" />
            </HorizontalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
